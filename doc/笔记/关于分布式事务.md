
## 分布式事务的产生的原因

1、数据库分库分表
当数据库单表一年产生的数据超过1000W，那么就要考虑分库分表，
具体分库分表的原理在此不做解释，以后有空详细说，简单的说就
是原来的一个数据库变成了多个数据库。这时候，如果一个操作既
访问01库，又访问02库，而且要保证数据的一致性，那么就要用到
分布式事务。

2、业务的服务化
比如原来单机支撑了整个电商网站，现在对整个网站进行拆解，分
离出了订单中心、用户中心、库存中心。对于订单中心，有专门
的数据库存储订单信息，用户中心也有专门的数据库存储用户信息，
库存中心也会有专门的数据库存储库存信息。这时候如果要同时对
订单和库存进行操作，那么就会涉及到订单数据库和库存数据库，
为了保证数据一致性，就需要用到分布式事务。

以上两种情况表象不同，但是本质相同，都是因为要操作的数据库变多了！

## 分布式事务的应用场景

1、支付
最经典的场景就是支付了，一笔支付，是对买家账户进行扣款，同时对
卖家账户进行加钱，这些操作必须在一个事务里执行，要么全部成功，
要么全部失败。 而对于买家账户属于买家中心，对应的是买家数据库，
而卖家账户属于卖家中心，对应的是卖家数据库，对不同数据库的操作
必然需要引入分布式事务。

2、在线下单
买家在电商平台下单，往往会涉及到两个动作，一个是扣库存，第二个
是更新订单状态，库存和订单一般属于不同的数据库，需要使用分布式
事务保证数据一致性。

## 解决方法-本地消息表

本地消息表与业务数据表处于同一个数据库中，这样就能利用本地事务
来保证在对这两个表的操作满足事务特性，并且使用了消息队列来保证
最终一致性。

在分布式事务操作的一方完成写业务数据的操作之后向本地消息表发送
一个消息，本地事务能保证这个消息一定会被写入本地消息表中。之后
将本地消息表中的消息转发到消息队列中，如果转发成功则将消息从本
地消息表中删除，否则继续重新转发。在分布式事务操作的另一方从消
息队列中读取一个消息，并执行消息中的操作。